# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

name: 1.0.$(Rev:r)

trigger:
- main

pool: 'Nitin'

stages:
- stage: BuildAndDeploy
  displayName: 'Build, Deploy & Run Tests'
  jobs:
  - job: RunTestAutomation
    steps:
      - checkout: self

      # Task 1: Install Platform
      - task: UiPathInstallPlatform@6
        displayName: '1. Install UiPath Platform'
        # Optional: Add inputs here if you need a specific version, but usually defaults are fine.

      # Task 2: Pack
      - task: UiPathPack@6
        displayName: '2. Pack UiPath Project'
        inputs:
          versionType: 'ManualVersion'
          version: '$(Build.BuildNumber)'
          # IMPORTANT: Verify this path is correct relative to your repository root
          projectJsonPath: '$(Build.SourcesDirectory)\project.json' 
          # Ensure outputType matches your project type (often Process or Tests)
          outputType: 'Tests' 
          orchestratorConnection: 'CICD_ConnectionOrch'
          # Store the package in the staging directory
          outputPath: '$(Build.ArtifactStagingDirectory)'

      # Task 3: Deploy - CORRECTED
      - task: UiPathDeploy@6
        displayName: '3. Deploy to Orchestrator'
        inputs:
          orchestratorConnection: 'CICD_ConnectionOrch'
          # Input is the directory where the package(s) are located. 
          # This should match the outputPath from UiPathPack.
          packagesPath: '$(Build.ArtifactStagingDirectory)' 
          # CRITICAL: This must be an exact, case-sensitive folder name in Orchestrator 
          folderName: 'Testing'
          # CRITICAL: This input is required for deploying a process (Main.xaml is the default)
          entryPoints: 'Main.xaml' 
          traceLevel: 'Information'

      # Task 4: Test
      - task: UiPathTest@6
        displayName: '4. Run Test Set'
        inputs:
          testTarget: 'TestSet'
          orchestratorConnection: 'CICD_ConnectionOrch'
          # CRITICAL: This must be an exact, case-sensitive Test Set name in Orchestrator
          testSet: 'CICD_Azure_TestSet' 
          folderName: 'Testing'
          testReportDestination: '$(Build.ArtifactStagingDirectory)\test-results.xml'
          traceLevel: 'Information'
          attachRobotLogs: true

      # Task 5: Publish Test Results (Optional but recommended)
      - task: PublishTestResults@2
        displayName: '5. Publish Test Results'
        # Ensures this step always runs, even if tests fail, so you see the results
        condition: always() 
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '$(Build.ArtifactStagingDirectory)\test-results.xml'
          failTaskOnFailedTests: true
          